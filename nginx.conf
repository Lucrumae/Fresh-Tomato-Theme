user nobody;
worker_processes 1;
pid /tmp/nginx.pid;
error_log /tmp/nginx_error.log;

events { worker_connections 64; }

http {
    access_log off;
    include /jffs/nginx/mime.types;

    map $http_x_login_auth $auth_header {
        default       "Basic __B64__";
        "~^Basic .+"  $http_x_login_auth;
    }

    server {
        listen 80;
        root /jffs/mywww;

        # Root → selalu login.html
        location = / {
            try_files /login.html =404;
        }

        # login.html — serve langsung, JANGAN redirect jika sudah login
        location = /login.html {
            try_files $uri =404;
        }

        # Logout — redirect ke login dengan flag ?logout=1
        location ~* ^/logout {
            return 302 /login.html?logout=1;
        }

        # .asp & .cgi — SELALU proxy, tidak pernah serve file langsung
        location ~* \.(asp|cgi)$ {
            proxy_pass http://192.168.1.1:8008;
            proxy_set_header Authorization $auth_header;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_buffering off;
            proxy_read_timeout 30s;
        }

        # bgmp4.gif — serve sebagai video/mp4
        location = /bgmp4.gif {
            types { video/mp4 gif; }
            try_files $uri =404;
        }

        # File statis yang PASTI ada di /jffs/mywww
        # Daftar eksplisit — jangan pakai wildcard agar tidak tangkap .asp
        location ~* \.(css|png|jpg|jpeg|ico|svg|woff|woff2)$ {
            try_files $uri @proxy;
        }

        # .js — serve dari /jffs/mywww dulu (theme js), fallback proxy
        location ~* \.js$ {
            try_files $uri @proxy;
        }

        # Semua lain → proxy
        location / {
            proxy_pass http://192.168.1.1:8008;
            proxy_set_header Authorization $auth_header;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_buffering off;
            proxy_read_timeout 30s;
        }

        location @proxy {
            proxy_pass http://192.168.1.1:8008;
            proxy_set_header Authorization $auth_header;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_buffering off;
        }
    }
}

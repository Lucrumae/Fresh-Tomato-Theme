<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FreshTomato — Login</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;600;700&family=Space+Mono:wght@400;700&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --panel-bg:   rgba(8,6,10,0.40);
    --panel-edge: rgba(255,255,255,0.10);
    --text-main:  #f0ece8;
    --text-dim:   rgba(240,236,232,0.50);
    --accent:     #e8a86e;
    --accent2:    #7ec8e3;
    --error:      #ff6b6b;
    --tr:         0.22s;
  }

  html, body {
    width:100%; height:100%;
    overflow:hidden;
    font-family:'Outfit',sans-serif;
    background:#080610;
  }

  /* VIDEO */
  #bg-video {
    position:fixed; inset:0;
    width:100vw; height:100vh;
    object-fit:cover; object-position:center;
    z-index:0; pointer-events:none;
  }

  /* OVERLAY */
  #bg-overlay {
    position:fixed; inset:0; z-index:1;
    background:rgba(8,6,10,0.38);
    transition:background 1.2s ease;
    pointer-events:none;
  }

  /* STAGE */
  .stage {
    position:relative; z-index:2;
    width:100%; height:100%;
    display:flex; align-items:center; justify-content:center;
  }

  /* CARD */
  .card {
    width:min(400px,90vw);
    background:var(--panel-bg);
    border:1px solid var(--panel-edge);
    border-radius:18px;
    padding:40px 36px 36px;
    backdrop-filter:blur(20px) saturate(1.5);
    -webkit-backdrop-filter:blur(20px) saturate(1.5);
    box-shadow:0 8px 48px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.06) inset;
    animation:cardIn 0.5s cubic-bezier(0.22,1,0.36,1) both;
    transition:background 1.2s ease, border-color 1.2s ease;
  }
  @keyframes cardIn {
    from{opacity:0;transform:translateY(24px) scale(0.97);}
    to  {opacity:1;transform:translateY(0)    scale(1);}
  }

  /* HEADER */
  .card-header { text-align:center; margin-bottom:32px; }
  .logo-row {
    display:flex; align-items:center;
    justify-content:center; gap:10px; margin-bottom:6px;
  }
  .logo-icon svg { width:32px; height:32px; }
  .logo-text {
    font-size:22px; font-weight:700;
    letter-spacing:-0.02em; color:var(--text-main);
    transition:color 1.2s;
  }
  .logo-text span { color:var(--accent); transition:color 1.2s; }
  .card-subtitle {
    font-size:11px; font-weight:300;
    letter-spacing:0.14em; text-transform:uppercase;
    color:var(--text-dim); font-family:'Space Mono',monospace;
    transition:color 1.2s;
  }

  /* DIVIDER */
  .divider {
    height:1px;
    background:linear-gradient(90deg,transparent,var(--panel-edge),transparent);
    margin-bottom:28px; transition:background 1.2s;
  }

  /* FIELD */
  .field { margin-bottom:16px; }
  .field label {
    display:block; font-size:11px; font-weight:600;
    letter-spacing:0.10em; text-transform:uppercase;
    color:var(--text-dim); margin-bottom:7px;
    font-family:'Space Mono',monospace; transition:color 1.2s;
  }
  .field-wrap { position:relative; display:flex; align-items:center; }
  .field-icon {
    position:absolute; left:13px;
    display:flex; align-items:center;
    pointer-events:none; opacity:0.4;
    transition:opacity var(--tr);
  }
  .field-icon svg {
    width:15px; height:15px;
    fill:none; stroke:var(--text-main);
    stroke-width:2; stroke-linecap:round; stroke-linejoin:round;
  }
  .field input {
    width:100%;
    padding:11px 12px 11px 38px;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.10);
    border-radius:10px;
    color:var(--text-main); font-size:14px;
    font-family:'Outfit',sans-serif;
    outline:none;
    transition:border-color var(--tr), background var(--tr), box-shadow var(--tr);
  }
  .field input::placeholder { color:rgba(240,236,232,0.25); }
  .field input:focus {
    border-color:var(--accent);
    background:rgba(255,255,255,0.09);
    box-shadow:0 0 0 3px rgba(232,168,110,0.13);
  }
  .field-wrap:focus-within .field-icon { opacity:0.85; }

  /* EYE BUTTON */
  .eye-btn {
    position:absolute; right:11px;
    background:none; border:none; cursor:pointer;
    padding:4px; color:var(--text-dim);
    display:flex; align-items:center;
    opacity:0.45; transition:opacity var(--tr);
  }
  .eye-btn:hover { opacity:1; }
  .eye-btn svg {
    width:15px; height:15px; fill:none;
    stroke:currentColor; stroke-width:2;
    stroke-linecap:round; stroke-linejoin:round;
  }

  /* ERROR */
  .error-msg {
    display:none; font-size:12px;
    color:var(--error); margin-top:5px; padding-left:2px;
  }
  .error-msg.show {
    display:block;
    animation:shake 0.35s ease;
  }
  @keyframes shake {
    0%,100%{transform:translateX(0);}
    25%    {transform:translateX(-5px);}
    75%    {transform:translateX(5px);}
  }

  /* BUTTON */
  .btn-login {
    width:100%; margin-top:22px; padding:13px;
    background:var(--accent); border:none;
    border-radius:10px; color:#0e0810;
    font-size:14px; font-weight:700;
    font-family:'Outfit',sans-serif;
    letter-spacing:0.04em; cursor:pointer;
    position:relative; overflow:hidden;
    transition:background 1.2s, transform var(--tr), box-shadow var(--tr), opacity var(--tr);
  }
  .btn-login::after {
    content:''; position:absolute; inset:0;
    background:rgba(255,255,255,0); transition:background 0.15s;
  }
  .btn-login:hover { transform:translateY(-2px); box-shadow:0 6px 24px rgba(232,168,110,0.35); }
  .btn-login:hover::after { background:rgba(255,255,255,0.07); }
  .btn-login:active { transform:translateY(0); box-shadow:none; }
  .btn-login.loading { opacity:0.7; pointer-events:none; }
  .btn-login .btn-text { transition:opacity 0.2s; }
  .btn-login .spinner {
    display:none; width:16px; height:16px;
    border:2px solid rgba(14,8,16,0.3);
    border-top-color:#0e0810; border-radius:50%;
    animation:spin 0.7s linear infinite;
    position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%);
  }
  .btn-login.loading .btn-text { opacity:0; }
  .btn-login.loading .spinner { display:block; }
  @keyframes spin { to{transform:translate(-50%,-50%) rotate(360deg);} }

  /* FOOTER */
  .card-footer {
    margin-top:20px; text-align:center;
    font-size:11px; color:var(--text-dim);
    font-family:'Space Mono',monospace; letter-spacing:0.04em;
  }
  .card-footer a {
    color:var(--accent2); text-decoration:none;
    opacity:0.75; transition:opacity var(--tr);
  }
  .card-footer a:hover { opacity:1; }

  /* UNMUTE POPUP */
  #ft-unmute-popup {
    position:fixed; bottom:24px; left:50%;
    transform:translateX(-50%);
    z-index:9999;
    background:rgba(10,10,10,0.82);
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    color:#fff; font-size:13px;
    font-family:'Outfit',sans-serif;
    padding:10px 22px; border-radius:24px;
    box-shadow:0 4px 16px rgba(0,0,0,0.5);
    cursor:pointer;
    display:flex; align-items:center; gap:8px;
    animation:popIn 0.3s ease;
  }
  @keyframes popIn {
    from{opacity:0;transform:translateX(-50%) translateY(12px);}
    to  {opacity:1;transform:translateX(-50%) translateY(0);}
  }
  .pop-out {
    animation:popOut 0.3s ease forwards !important;
  }
  @keyframes popOut {
    from{opacity:1;transform:translateX(-50%) translateY(0);}
    to  {opacity:0;transform:translateX(-50%) translateY(12px);}
  }
</style>
</head>
<body>

<video id="bg-video" autoplay loop muted playsinline>
  <source src="/bgmp4.gif" type="video/mp4">
</video>
<div id="bg-overlay"></div>

<div class="stage">
  <div class="card" id="card">

    <div class="card-header">
      <div class="logo-row">
        <div class="logo-icon">
          <svg viewBox="0 0 48 48" fill="none">
            <ellipse cx="24" cy="28" rx="18" ry="16" fill="var(--accent)" opacity="0.9"/>
            <ellipse cx="24" cy="28" rx="18" ry="16" fill="url(#tg)" opacity="0.6"/>
            <path d="M24 13C24 13 20 6 14 8C18 8 20 13 24 13Z" fill="#4caf50"/>
            <path d="M24 13C24 13 28 6 34 8C30 8 28 13 24 13Z" fill="#388e3c"/>
            <path d="M24 13C22 8 24 4 24 4C24 4 26 8 24 13Z" fill="#66bb6a"/>
            <defs>
              <linearGradient id="tg" x1="6" y1="14" x2="42" y2="44" gradientUnits="userSpaceOnUse">
                <stop stop-color="#ffb347"/>
                <stop offset="1" stop-color="#c0392b"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <div class="logo-text">Fresh<span>Tomato</span></div>
      </div>
      <div class="card-subtitle">Router Administration</div>
    </div>

    <div class="divider"></div>

    <form id="form" autocomplete="on">
      <div class="field">
        <label for="username">Username</label>
        <div class="field-wrap">
          <input id="username" type="text" name="username"
                 placeholder="admin" autocomplete="username" spellcheck="false">
          <span class="field-icon">
            <svg viewBox="0 0 24 24">
              <circle cx="12" cy="8" r="4"/>
              <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
            </svg>
          </span>
        </div>
      </div>

      <div class="field">
        <label for="password">Password</label>
        <div class="field-wrap">
          <input id="password" type="password" name="password"
                 placeholder="••••••••" autocomplete="current-password">
          <span class="field-icon">
            <svg viewBox="0 0 24 24">
              <rect x="3" y="11" width="18" height="11" rx="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
          </span>
          <button type="button" class="eye-btn" id="eye-btn">
            <svg id="eye-svg" viewBox="0 0 24 24">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
        </div>
        <div class="error-msg" id="err"></div>
      </div>

      <button type="submit" class="btn-login" id="btn">
        <span class="btn-text">Sign In</span>
        <span class="spinner"></span>
      </button>
    </form>

    <div class="card-footer">
      <a href="http://freshtomato.org" target="_blank">FreshTomato</a>
      &nbsp;·&nbsp; Router Admin Panel
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  // ── ADAPTIVE COLOR ─────────────────────────────────────────
  var vid     = document.getElementById('bg-video');
  var overlay = document.getElementById('bg-overlay');
  var card    = document.getElementById('card');
  var cv      = document.createElement('canvas');
  cv.width=64; cv.height=36;
  var ctx     = cv.getContext('2d');
  var lastHue = -1, lastTs = 0;

  function H(h,s,l){
    h/=360;s/=100;l/=100;
    var q=l<.5?l*(1+s):l+s-l*s,p=2*l-q;
    function f(t){t<0&&(t+=1);t>1&&(t-=1);
      return t<1/6?p+(q-p)*6*t:t<.5?q:t<2/3?p+(q-p)*(2/3-t)*6:p;}
    return[~~(f(h+1/3)*255),~~(f(h)*255),~~(f(h-1/3)*255)];
  }
  function toHsl(r,g,b){
    r/=255;g/=255;b/=255;
    var mx=Math.max(r,g,b),mn=Math.min(r,g,b),h,s,l=(mx+mn)/2;
    if(mx===mn){h=s=0;}else{
      var d=mx-mn;s=l>.5?d/(2-mx-mn):d/(mx+mn);
      h=mx===r?((g-b)/d+(g<b?6:0))/6:mx===g?((b-r)/d+2)/6:((r-g)/d+4)/6;
    }
    return[h*360,s*100,l*100];
  }

  function adaptLoop(ts){
    if(ts-lastTs>120){
      lastTs=ts;
      if(vid.readyState>=2){
        try{
          ctx.drawImage(vid,0,0,64,36);
          var px=ctx.getImageData(0,0,64,36).data,r=0,g=0,b=0,n=0;
          for(var i=0;i<px.length;i+=4){
            var br=(px[i]+px[i+1]+px[i+2])/3;
            if(br<15||br>240)continue;
            r+=px[i];g+=px[i+1];b+=px[i+2];n++;
          }
          if(n){
            r=~~(r/n);g=~~(g/n);b=~~(b/n);
            var hsl=toHsl(r,g,b),hue=hsl[0],sat=hsl[1],lum=hsl[2];
            var d=Math.abs(hue-lastHue);if(d>180)d=360-d;
            if(lastHue<0||d>=5){
              lastHue=hue;
              var dark=lum<50, s2=Math.max(sat,50);
              var acc =H(hue,         Math.max(s2,65), dark?68:42);
              var acc2=H((hue+40)%360,Math.max(s2,55), dark?72:40);
              var pan =H(hue,         Math.min(s2,40), dark?Math.min(lum+8,20):Math.max(lum-8,80));
              var ov  =Math.max(pan[0]-30,0)+','+Math.max(pan[1]-30,0)+','+Math.max(pan[2]-30,0);
              overlay.style.background    ='rgba('+ov+',0.42)';
              card.style.background       ='rgba('+pan[0]+','+pan[1]+','+pan[2]+',0.36)';
              card.style.borderColor      ='rgba('+acc[0]+','+acc[1]+','+acc[2]+',0.20)';
              document.documentElement.style.setProperty('--accent','rgb('+acc[0]+','+acc[1]+','+acc[2]+')');
              document.documentElement.style.setProperty('--accent2','rgb('+acc2[0]+','+acc2[1]+','+acc2[2]+')');
              document.documentElement.style.setProperty('--panel-edge','rgba('+acc[0]+','+acc[1]+','+acc[2]+',0.20)');
              document.body.style.background='rgb('+Math.max(pan[0]-45,0)+','+Math.max(pan[1]-45,0)+','+Math.max(pan[2]-45,0)+')';
            }
          }
        }catch(e){}
      }
    }
    requestAnimationFrame(adaptLoop);
  }

  // Mulai loop — video tetap muted agar autoplay lolos
  vid.muted=true;
  vid.play().catch(function(){});
  requestAnimationFrame(adaptLoop);

  // ── UNMUTE POPUP ───────────────────────────────────────────
  if(localStorage.getItem('ft_bg_muted')==='false'){
    setTimeout(function(){
      var p=document.createElement('div');
      p.id='ft-unmute-popup';
      p.innerHTML=
        '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'+
        '<path d="M11 5L6 9H2v6h4l5 4V5z"/>'+
        '<path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>'+
        '<path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>'+
        'Click anywhere to unmute';
      function bye(unmute){
        p.classList.add('pop-out');
        setTimeout(function(){p.parentNode&&p.parentNode.removeChild(p);},300);
        if(unmute){vid.muted=false;localStorage.setItem('ft_bg_muted','false');}
      }
      p.addEventListener('click',function(e){e.stopPropagation();bye(true);});
      document.addEventListener('click',function once(){
        document.removeEventListener('click',once);bye(true);
      },{once:true});
      setTimeout(function(){bye(false);},5000);
      document.body.appendChild(p);
    },700);
  }

  // ── SHOW / HIDE PASSWORD ───────────────────────────────────
  var pwdEl  = document.getElementById('password');
  var eyeBtn = document.getElementById('eye-btn');
  var eyeSvg = document.getElementById('eye-svg');
  var OPEN   = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
  var CLOSED = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/>';
  eyeBtn.addEventListener('click',function(){
    var show=pwdEl.type==='password';
    pwdEl.type=show?'text':'password';
    eyeSvg.innerHTML=show?CLOSED:OPEN;
  });

  // ── LOGIN ──────────────────────────────────────────────────
  // POST ke auth.cgi → reply "OK:<token>" atau "FAIL"
  // Token disimpan di sessionStorage → redirect ke index.asp
  // http_passwd dikosongkan di router → tidak ada Basic Auth popup
  var form  = document.getElementById('form');
  var btn   = document.getElementById('btn');
  var errEl = document.getElementById('err');

  // Cek jika sudah punya session yang valid
  var existingToken = sessionStorage.getItem('ft_session');
  if(existingToken){
    window.location.replace('/index.asp');
  }

  form.addEventListener('submit',function(e){
    e.preventDefault();
    var user = document.getElementById('username').value.trim();
    var pass = pwdEl.value;
    if(!user||!pass){ showErr('Please enter username and password.'); return; }

    errEl.classList.remove('show');
    btn.classList.add('loading');

    var body = 'user='+encodeURIComponent(user)+'&pass='+encodeURIComponent(pass);

    fetch('/auth.cgi',{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded','Content-Length':body.length},
      body:body
    })
    .then(function(r){ return r.text(); })
    .then(function(txt){
      txt = (txt||'').trim();
      if(txt.indexOf('OK:')===0){
        var token = txt.slice(3);
        sessionStorage.setItem('ft_session', token);
        sessionStorage.setItem('ft_user', user);
        setTimeout(function(){ window.location.replace('/index.asp'); }, 60);
      } else {
        btn.classList.remove('loading');
        showErr('Invalid username or password.');
        pwdEl.value=''; pwdEl.focus();
      }
    })
    .catch(function(){
      btn.classList.remove('loading');
      showErr('Cannot reach router. Check connection.');
    });
  });

  function showErr(msg){
    errEl.textContent = msg;
    errEl.classList.remove('show');
    void errEl.offsetWidth;
    errEl.classList.add('show');
  }

  // Auto-focus username
  setTimeout(function(){ document.getElementById('username').focus(); },550);
})();
</script>
</body>
</html>

#!/bin/sh

# =================================================================
# GLOBAL CONFIGURATION
# =================================================================
BASE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main"
LIST_FILE="ThemeList.txt"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_deploy"

# ANSI Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Auto-cleanup RAM on exit/error
cleanup() {
    [ -d "$TEMP_WORKSPACE" ] && rm -rf "$TEMP_WORKSPACE"
}
trap cleanup EXIT INT TERM

# =================================================================
# PHASE 1: THEME SELECTION MENU
# =================================================================
clear
echo -e "${CYAN}===================================================="
echo -e "      FreshTomato Multi-Theme Installer Pro"
echo -e "      Database: ${LIST_FILE}"
echo -e "${CYAN}====================================================${NC}"

mkdir -p "$TEMP_WORKSPACE"
echo -n "Fetching theme catalog... "
wget --no-check-certificate "$BASE_URL/$LIST_FILE" -O "$TEMP_WORKSPACE/list.txt" >/dev/null 2>&1

if [ ! -s "$TEMP_WORKSPACE/list.txt" ]; then
    echo -e "${RED}[FAILED]${NC}"
    echo -e "Error: Could not retrieve theme list from GitHub."
    exit 1
fi
echo -e "${GREEN}[OK]${NC}"

echo -e "\n${YELLOW}Available Themes in Repository:${NC}"
echo -e "----------------------------------------------------"

i=1
while IFS='|' read -r name folder || [ -n "$name" ]; do
    clean_name=$(echo "$name" | tr -d '\r')
    clean_folder=$(echo "$folder" | tr -d '\r')
    
    [ -z "$clean_name" ] && continue
    
    echo -e "${CYAN}$i)${NC} $clean_name"
    eval "NAME_$i=\"$clean_name\""
    eval "FOLDER_$i=\"$clean_folder\""
    i=$((i+1))
done < "$TEMP_WORKSPACE/list.txt"

total_themes=$((i-1))
if [ "$total_themes" -eq 0 ]; then
    echo -e "${RED}No themes found in catalog.${NC}"
    exit 1
fi

echo -e "----------------------------------------------------"
printf "Enter selection (1-$total_themes): "
read choice

SELECTED_NAME=$(eval echo \$NAME_$choice)
SELECTED_FOLDER=$(eval echo \$FOLDER_$choice)

if [ -z "$SELECTED_NAME" ]; then
    echo -e "${RED}Invalid selection. Installation aborted.${NC}"
    exit 1
fi

# =================================================================
# PHASE 2: SYSTEM & SPACE CHECKS
# =================================================================
log_step() { echo -e "${CYAN}[$1/5]${NC} $2"; }

if ! mount | grep -q "/jffs"; then
    echo -e "${RED}[ERROR] JFFS partition is not active.${NC}"
    exit 1
fi

# Cek sisa ruang JFFS (Minimal butuh 10MB free)
FREE_JFFS=$(df -k /jffs | awk 'NR==2 {print $4}')
if [ "$FREE_JFFS" -lt 10240 ]; then
    echo -e "${YELLOW}[WARNING] Low JFFS space ($((FREE_JFFS/1024))MB). Installation might fail.${NC}"
fi

# =================================================================
# PHASE 3: PREPARATION & MIRRORING
# =================================================================
log_step "1" "Cleaning previous environment..."
umount -l /www 2>/dev/null
[ -d "$INSTALL_PATH" ] && rm -rf "$INSTALL_PATH"

log_step "2" "Mirroring system files to JFFS..."
mkdir -p "$INSTALL_PATH"
cp -a /www/. "$INSTALL_PATH/"
rm -f "$INSTALL_PATH/default.css"

# =================================================================
# PHASE 4: DOWNLOAD & DEPLOYMENT
# =================================================================
# Updated URL: Menggunakan Theme.tar sesuai permintaan Anda
THEME_URL="$BASE_URL/$SELECTED_FOLDER/Theme.tar"

log_step "3" "Downloading $SELECTED_NAME package..."
wget --no-check-certificate "$THEME_URL" -O "$TEMP_WORKSPACE/Theme.tar"

if [ $? -ne 0 ]; then
    echo -e "${RED}[ERROR] Failed to download Theme.tar from $SELECTED_FOLDER${NC}"
    exit 1
fi

log_step "4" "Extracting assets to JFFS storage..."
tar -xf "$TEMP_WORKSPACE/Theme.tar" -C "$INSTALL_PATH/"
# =================================================================
# PHASE 5: PERSISTENCE & ACTIVATION
# =================================================================
log_step "5" "Configuring boot sequence & Permissions..."
chmod 755 "$INSTALL_PATH"
chmod 644 "$INSTALL_PATH"/*

# NVRAM Startup Script Persistence
CURRENT_INIT=$(nvram get script_init | sed "/# --- Theme Startup ---/,/fi/d")
nvram set script_init="$CURRENT_INIT
# --- Theme Startup ---
sleep 10
if [ -d $INSTALL_PATH ]; then
    chmod 755 $INSTALL_PATH
    chmod 644 $INSTALL_PATH/*
    mount --bind $INSTALL_PATH /www
    service httpd restart
fi"
nvram commit

# Final Activation
mount --bind "$INSTALL_PATH" /www
service httpd restart

echo -e "\n${GREEN}===================================================="
echo -e "      INSTALLATION SUCCESSFUL: $SELECTED_NAME"
echo -e "====================================================${NC}"
echo -e "Status: ${CYAN}Active${NC}"
echo -e "RAM Usage: ${CYAN}Auto-Cleaned${NC}"
echo -e "\nAction: Please Clear Browser Cache (CTRL+F5)"
echo -e "----------------------------------------------------"

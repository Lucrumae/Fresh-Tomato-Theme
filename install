#!/bin/sh

# =================================================================
# FreshTomato Theme Installer - Professional Edition (25MB Limit)
# Theme: BocchiTheRockTheme
# =================================================================

echo "===================================================="
echo "      BocchiTheRockTheme Installation Wizard        "
echo "===================================================="

# --- CONFIGURATION ---
SOURCE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main/BocchiTheRockTheme/BocchiTheme.tar"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_extract"
REQUIRED_SPACE=25600  # Adjusted to 25MB (25600 KB)

# 1. ENVIRONMENT VALIDATION
if ! mount | grep -q "/jffs"; then
    echo "[ERROR] JFFS partition is not mounted."
    exit 1
fi

# 2. REINSTALLATION HANDLER
if [ -d "$INSTALL_PATH" ]; then
    echo "[INFO] Existing installation detected."
    printf "Reinstall and overwrite? (y/n): "
    read choice
    if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
        echo "[ACTION] Unmounting and cleaning previous paths..."
        umount -l /www 2>/dev/null
        rm -rf "$INSTALL_PATH"
    else
        echo "[INFO] Installation aborted."
        exit 0
    fi
fi

# 3. SYSTEM RESOURCE CHECK
FREE_RAM=$(df -k /tmp | awk 'NR==2 {print $4}')
if [ "$FREE_RAM" -lt "$REQUIRED_SPACE" ]; then
    echo "[ERROR] Insufficient RAM. Required: 25MB | Available: $((FREE_RAM / 1024))MB"
    exit 1
fi

# 4. DIRECTORY MIRRORING
echo "[1/7] Mirroring system files to JFFS..."
mkdir -p "$INSTALL_PATH"
cp -a /www/. "$INSTALL_PATH/"
echo "[SUCCESS] System directory mirrored to JFFS."

# 5. TARGET DELETION
echo "[2/7] Removing original default.css from JFFS..."
rm -f "$INSTALL_PATH/default.css"

if [ -f "$INSTALL_PATH/default.css" ]; then
    echo "[ERROR] Failed to delete default.css. Process halted."
    exit 1
fi
echo "[SUCCESS] Original default.css has been removed."

# 6. DOWNLOAD PHASE
mkdir -p "$TEMP_WORKSPACE"
cd "$TEMP_WORKSPACE" || exit
echo "[3/7] Downloading theme package (25MB limit check)..."
wget --no-check-certificate -U "Mozilla/5.0" "$SOURCE_URL"

if [ ! -s "BocchiTheme.tar" ]; then
    echo "[ERROR] Download failed or file is empty."
    exit 1
fi

# 7. EXTRACTION
echo "[4/7] Extracting theme assets..."
tar -xf BocchiTheme.tar

# 8. DEPLOYMENT
echo "[5/7] Deploying new assets to JFFS..."
cp -a . "$INSTALL_PATH/"

cd /
rm -rf "$TEMP_WORKSPACE"

# 9. NVRAM PERSISTENCE
echo "[6/7] Configuring persistence (NVRAM)..."
CURRENT_INIT=$(nvram get script_init)
if ! echo "$CURRENT_INIT" | grep -q "$INSTALL_PATH"; then
    nvram set script_init="$CURRENT_INIT
sleep 5
if [ -d $INSTALL_PATH ]; then
    mount --bind $INSTALL_PATH /www
    service httpd restart
fi"
    nvram commit
fi

# 10. RE-MOUNT & ACTIVATION
echo "[7/7] Re-mounting /www to JFFS and restarting Web Server..."
umount -l /www 2>/dev/null
mount --bind "$INSTALL_PATH" /www
service httpd restart

echo "===================================================="
echo "           INSTALLATION SUCCESSFUL!                 "
echo "===================================================="

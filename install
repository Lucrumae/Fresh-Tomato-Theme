#!/bin/sh

# =================================================================
# FreshTomato Theme Installer - Professional Edition
# Theme: BocchiTheRockTheme
# Repository: https://github.com/Lucrumae/Fresh-Tomato-Theme
# =================================================================

echo "===================================================="
echo "      BocchiTheRockTheme Installation Wizard        "
echo "===================================================="

# --- CONFIGURATION ---
SOURCE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main/BocchiTheRockTheme/BocchiTheme.tar"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_extract"
REQUIRED_SPACE=46080  # ~45MB for extraction safety

# 1. ENVIRONMENT VALIDATION
if ! mount | grep -q "/jffs"; then
    echo "[ERROR] JFFS partition is not mounted. Please enable it in Administration > JFFS."
    exit 1
fi

# 2. REINSTALLATION HANDLER
if [ -d "$INSTALL_PATH" ]; then
    echo "[INFO] Existing installation detected at $INSTALL_PATH."
    printf "Would you like to reinstall and overwrite existing assets? (y/n): "
    read choice
    if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
        echo "[ACTION] Removing previous installation..."
        umount -l /www 2>/dev/null
        rm -rf "$INSTALL_PATH"
    else
        echo "[INFO] Installation aborted by user."
        exit 0
    fi
fi

# 3. SYSTEM RESOURCE CHECK
FREE_RAM=$(df -k /tmp | awk 'NR==2 {print $4}')
if [ "$FREE_RAM" -lt "$REQUIRED_SPACE" ]; then
    echo "[ERROR] Insufficient RAM in /tmp. Required: ~45MB | Available: $((FREE_RAM / 1024))MB"
    exit 1
fi

# 4. DIRECTORY INITIALIZATION
echo "[1/6] Initializing JFFS workspace..."
mkdir -p "$INSTALL_PATH"
cp -rn /www/* "$INSTALL_PATH/"

# 5. DOWNLOAD PHASE
mkdir -p "$TEMP_WORKSPACE"
cd "$TEMP_WORKSPACE" || exit
echo "[2/6] Downloading theme package from GitHub..."
wget --no-check-certificate -U "Mozilla/5.0" "$SOURCE_URL"

if [ ! -s "BocchiTheme.tar" ]; then
    echo "[ERROR] Download failed. The remote file is missing or empty."
    exit 1
fi

# 6. ASSET EXTRACTION & OVERWRITE
echo "[3/6] Preparing asset replacement..."

# Specifically removing the original CSS to ensure a clean overwrite
if [ -f "$INSTALL_PATH/default.css" ]; then
    rm -f "$INSTALL_PATH/default.css"
    echo "[INFO] Original default.css removed from workspace."
fi

echo "[4/6] Extracting new assets..."
tar -xf BocchiTheme.tar

# Copying extracted files to JFFS
# Using -f (force) to ensure any remaining assets are replaced
cp -f default.css logol.png logor.png bg.gif "$INSTALL_PATH/" 2>/dev/null

# Immediate Cleanup
cd /
rm -rf "$TEMP_WORKSPACE"

# 7. NVRAM PERSISTENCE
echo "[5/6] Configuring persistence (NVRAM Init Script)..."
CURRENT_INIT=$(nvram get script_init)
if ! echo "$CURRENT_INIT" | grep -q "$INSTALL_PATH"; then
    nvram set script_init="$CURRENT_INIT
sleep 5
if [ -d $INSTALL_PATH ]; then
    mount --bind $INSTALL_PATH /www
    service httpd restart
fi"
    nvram commit
    echo "[SUCCESS] Init script updated in NVRAM."
else
    echo "[INFO] Init script already exists. Skipping update."
fi

# 8. THEME ACTIVATION
echo "[6/6] Activating theme..."
mount --bind "$INSTALL_PATH" /www
service httpd restart

echo "===================================================="
echo "           INSTALLATION SUCCESSFUL!                 "
echo "===================================================="
echo " Please refresh your browser and clear your cache."
echo "===================================================="

#!/bin/sh

# =================================================================
# GLOBAL CONFIGURATION
# =================================================================
BASE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main"
LIST_FILE="ThemeList.txt"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_deploy"

# ANSI Colors & Styles
CYAN='\033[0;36m'
BCYAN='\033[1;36m'
GREEN='\033[0;32m'
BGREEN='\033[1;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
PINK='\033[1;35m'
WHITE='\033[1;37m'
DIM='\033[2m'
NC='\033[0m'

# Cleanup RAM saat exit/error
cleanup() {
    [ -d "$TEMP_WORKSPACE" ] && rm -rf "$TEMP_WORKSPACE"
}
trap cleanup EXIT INT TERM

# Helper
divider() { echo -e "${DIM}  ────────────────────────────────────────────────${NC}"; }
ok()   { echo -e "  ${BGREEN}✔${NC}  $1"; }
fail() { echo -e "  ${RED}✘${NC}  $1"; }
info() { echo -e "  ${CYAN}→${NC}  $1"; }
warn() { echo -e "  ${YELLOW}⚠${NC}  $1"; }

# BusyBox wget wrapper (tidak support --tries, pakai -T untuk timeout saja)
do_wget() {
    wget --no-check-certificate -T 15 "$1" -O "$2" 2>/dev/null
}

# =================================================================
# PHASE 1: THEME SELECTION MENU
# =================================================================
clear
echo ""
echo -e "${PINK}  ████████╗██╗  ██╗███████╗███╗   ███╗███████╗${NC}"
echo -e "${PINK}     ██╔══╝██║  ██║██╔════╝████╗ ████║██╔════╝${NC}"
echo -e "${PINK}     ██║   ███████║█████╗  ██╔████╔██║█████╗  ${NC}"
echo -e "${PINK}     ██║   ██╔══██║██╔══╝  ██║╚██╔╝██║██╔══╝  ${NC}"
echo -e "${PINK}     ██║   ██║  ██║███████╗██║ ╚═╝ ██║███████╗${NC}"
echo -e "${PINK}     ╚═╝   ╚═╝  ╚══════╝╚═╝     ╚═╝╚══════╝${NC}"
echo ""
echo -e "${WHITE}        FreshTomato Theme Installer${NC}  ${DIM}by Lucrumae${NC}"
divider
echo ""

mkdir -p "$TEMP_WORKSPACE"
echo -ne "  ${CYAN}↓${NC}  Fetching theme catalog from GitHub... "

do_wget "$BASE_URL/$LIST_FILE" "$TEMP_WORKSPACE/list.txt"

if [ ! -s "$TEMP_WORKSPACE/list.txt" ]; then
    echo -e "${RED}failed${NC}"
    echo ""
    fail "Unable to reach GitHub. Check your internet connection."
    echo ""
    exit 1
fi
echo -e "${BGREEN}done${NC}"
echo ""

echo -e "  ${WHITE}Available Themes${NC}"
divider

i=1
while IFS='|' read -r name folder || [ -n "$name" ]; do
    clean_name=$(echo "$name" | tr -d '\r\n')
    clean_folder=$(echo "$folder" | tr -d '\r\n')
    [ -z "$clean_name" ] && continue
    echo -e "  ${PINK}$i)${NC}  $clean_name  ${DIM}← $clean_folder${NC}"
    echo "$clean_name"   >> "$TEMP_WORKSPACE/names.txt"
    echo "$clean_folder" >> "$TEMP_WORKSPACE/folders.txt"
    i=$((i+1))
done < "$TEMP_WORKSPACE/list.txt"

total_themes=$((i-1))
if [ "$total_themes" -eq 0 ]; then
    echo ""
    fail "No themes found in catalog. The list file may be empty."
    echo ""
    exit 1
fi

divider
echo ""
printf "  Select a theme (1-$total_themes): "
read choice < /dev/tty

# Validasi input
case "$choice" in
    ''|*[!0-9]*)
        echo ""
        fail "Invalid input — please enter a number between 1 and $total_themes."
        echo ""
        exit 1
        ;;
esac

if [ "$choice" -lt 1 ] || [ "$choice" -gt "$total_themes" ]; then
    echo ""
    fail "Out of range — no theme #$choice in the list."
    echo ""
    exit 1
fi

SELECTED_NAME=$(sed -n "${choice}p" "$TEMP_WORKSPACE/names.txt")
SELECTED_FOLDER=$(sed -n "${choice}p" "$TEMP_WORKSPACE/folders.txt")

if [ -z "$SELECTED_NAME" ] || [ -z "$SELECTED_FOLDER" ]; then
    fail "Could not resolve theme. Aborting."
    exit 1
fi

# =================================================================
# PHASE 2: SYSTEM & SPACE CHECKS
# =================================================================
echo ""
echo -e "  ${WHITE}System Checks${NC}"
divider

if ! mount | grep -q "/jffs"; then
    fail "JFFS partition is not mounted. Enable JFFS in Administration first."
    echo ""
    exit 1
fi
ok "JFFS partition is active"

FREE_JFFS=$(df -k /jffs | awk 'NR==2 {print $4}')
if [ "$FREE_JFFS" -lt 10240 ]; then
    warn "Low JFFS space detected (${FREE_JFFS}KB free). Installation may fail."
else
    ok "Sufficient JFFS space available (${FREE_JFFS}KB free)"
fi

echo ""
echo -e "  ${WHITE}Installing:${NC} ${PINK}$SELECTED_NAME${NC}"
divider

# =================================================================
# PHASE 3: PREPARATION & MIRRORING
# =================================================================
echo -ne "  ${CYAN}[1/5]${NC}  Cleaning up previous installation...    "
if mount | grep -q " /www "; then
    umount -l /www 2>/dev/null
fi
[ -d "$INSTALL_PATH" ] && rm -rf "$INSTALL_PATH"
echo -e "${BGREEN}done${NC}"

echo -ne "  ${CYAN}[2/5]${NC}  Mirroring /www to JFFS storage...       "
mkdir -p "$INSTALL_PATH"
cp -a /www/. "$INSTALL_PATH/"
rm -f "$INSTALL_PATH/default.css"
echo -e "${BGREEN}done${NC}"

# =================================================================
# PHASE 4: DOWNLOAD & DEPLOYMENT
# =================================================================
THEME_URL="$BASE_URL/$SELECTED_FOLDER/Theme.tar"

echo -ne "  ${CYAN}[3/5]${NC}  Downloading theme package...            "
do_wget "$THEME_URL" "$TEMP_WORKSPACE/Theme.tar"

if [ $? -ne 0 ] || [ ! -s "$TEMP_WORKSPACE/Theme.tar" ]; then
    echo -e "${RED}failed${NC}"
    echo ""
    fail "Could not download Theme.tar. Check the folder name in ThemeList.txt."
    echo ""
    exit 1
fi
echo -e "${BGREEN}done${NC}"

echo -ne "  ${CYAN}[4/5]${NC}  Extracting theme assets...              "
tar -xf "$TEMP_WORKSPACE/Theme.tar" -C "$INSTALL_PATH/" 2>/dev/null
if [ $? -ne 0 ]; then
    echo -e "${RED}failed${NC}"
    echo ""
    fail "Extraction failed. Theme.tar may be corrupted or in wrong format."
    echo ""
    exit 1
fi
echo -e "${BGREEN}done${NC}"

# =================================================================
# PHASE 5: PERSISTENCE & ACTIVATION
# =================================================================
echo -ne "  ${CYAN}[5/5]${NC}  Configuring permissions & boot hooks... "

chmod 755 "$INSTALL_PATH"
# BusyBox find tidak support -type, pakai chmod langsung
chmod 644 "$INSTALL_PATH"/*
chmod 755 "$INSTALL_PATH"/*.sh 2>/dev/null
chmod 755 "$INSTALL_PATH"/*.cgi 2>/dev/null

SAFE_PATH=$(echo "$INSTALL_PATH" | tr -cd 'a-zA-Z0-9/_-')

CURRENT_INIT=$(nvram get script_init | sed "/# --- Theme Startup ---/,/fi/d")
nvram set script_init="$CURRENT_INIT
# --- Theme Startup ---
sleep 10
if [ -d $SAFE_PATH ]; then
    chmod 755 $SAFE_PATH
    chmod 644 $SAFE_PATH/*
    chmod 755 $SAFE_PATH/*.sh 2>/dev/null
    chmod 755 $SAFE_PATH/*.cgi 2>/dev/null
    mount --bind $SAFE_PATH /www
    service httpd restart
fi"
nvram commit >/dev/null 2>&1

mount --bind "$INSTALL_PATH" /www
service httpd restart >/dev/null 2>&1
echo -e "${BGREEN}done${NC}"

# =================================================================
# DONE
# =================================================================
echo ""
divider
echo ""
echo -e "  ${BGREEN}✔  Installation complete!${NC}"
echo ""
echo -e "  ${WHITE}Theme   ${NC}${PINK}$SELECTED_NAME${NC}"
echo -e "  ${WHITE}Path    ${NC}${DIM}$INSTALL_PATH${NC}"
echo -e "  ${WHITE}Status  ${NC}${BGREEN}Active & persistent across reboots${NC}"
echo ""
echo -e "  ${YELLOW}⚑  Press Ctrl+F5 in your browser to clear cache.${NC}"
echo ""
divider
echo ""

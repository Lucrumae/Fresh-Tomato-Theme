#!/bin/sh

# =================================================================
# FreshTomato Theme Installer - Professional Edition (Strict Flow)
# Theme: BocchiTheRockTheme
# =================================================================

echo "===================================================="
echo "      BocchiTheRockTheme Installation Wizard        "
echo "===================================================="

# --- CONFIGURATION ---
SOURCE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main/BocchiTheRockTheme/BocchiTheme.tar"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_extract"

# 1. ENVIRONMENT VALIDATION
if ! mount | grep -q "/jffs"; then
    echo "[ERROR] JFFS partition is not mounted."
    exit 1
fi

# 2. REINSTALLATION HANDLER
if [ -d "$INSTALL_PATH" ]; then
    echo "[INFO] Existing installation detected."
    printf "Reinstall and overwrite? (y/n): "
    read choice
    if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
        umount -l /www 2>/dev/null
        rm -rf "$INSTALL_PATH"
    else
        echo "[INFO] Installation aborted."
        exit 0
    fi
fi

# 3. DIRECTORY MIRRORING (Step 1)
echo "[1/7] Mirroring system files to JFFS..."
mkdir -p "$INSTALL_PATH"
cp -a /www/. "$INSTALL_PATH/"

# Verification: Check if a crucial file exists in the mirror
if [ ! -f "$INSTALL_PATH/index.asp" ]; then
    echo "[ERROR] System mirroring failed. JFFS might be full."
    exit 1
fi
echo "[SUCCESS] System mirrored successfully."

# 4. TARGET REMOVAL (Step 2)
echo "[2/7] Removing original default.css from JFFS..."
if [ -f "$INSTALL_PATH/default.css" ]; then
    rm -f "$INSTALL_PATH/default.css"
fi

# Double-check if the file is truly gone
if [ -f "$INSTALL_PATH/default.css" ]; then
    echo "[ERROR] Failed to remove original default.css. Permission denied?"
    exit 1
fi
echo "[SUCCESS] Original default.css verified as deleted."

# 5. DOWNLOAD PHASE (Step 3)
mkdir -p "$TEMP_WORKSPACE"
cd "$TEMP_WORKSPACE" || exit
echo "[3/7] Downloading theme package..."
wget --no-check-certificate -U "Mozilla/5.0" "$SOURCE_URL"

if [ ! -s "BocchiTheme.tar" ]; then
    echo "[ERROR] Download failed. Remote file not found."
    exit 1
fi

# 6. EXTRACTION (Step 4)
echo "[4/7] Extracting theme assets..."
tar -xf BocchiTheme.tar

# 7. DEPLOYMENT (Step 5)
echo "[5/7] Deploying new assets to JFFS..."
# Simple copy without override flags, since the target folder is ready
cp -a . "$INSTALL_PATH/"

# Cleanup RAM
cd /
rm -rf "$TEMP_WORKSPACE"

# 8. NVRAM PERSISTENCE
echo "[6/7] Configuring persistence (NVRAM)..."
CURRENT_INIT=$(nvram get script_init)
if ! echo "$CURRENT_INIT" | grep -q "$INSTALL_PATH"; then
    nvram set script_init="$CURRENT_INIT
sleep 5
if [ -d $INSTALL_PATH ]; then
    mount --bind $INSTALL_PATH /www
    service httpd restart
fi"
    nvram commit
fi

# 9. ACTIVATION
echo "[7/7] Activating theme..."
mount --bind "$INSTALL_PATH" /www
service httpd restart

echo "===================================================="
echo "           INSTALLATION SUCCESSFUL!                 "
echo "===================================================="

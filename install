#!/bin/sh

# =================================================================
# FreshTomato Theme Installer - Professional Edition (Strict Flow)
# Theme: BocchiTheRockTheme
# =================================================================

echo "===================================================="
echo "      BocchiTheRockTheme Installation Wizard        "
echo "===================================================="

# --- CONFIGURATION ---
SOURCE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main/BocchiTheRockTheme/BocchiTheme.tar"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_extract"

# 1. ENVIRONMENT VALIDATION
if ! mount | grep -q "/jffs"; then
    echo "[ERROR] JFFS partition is not mounted."
    exit 1
fi

# 2. REINSTALLATION HANDLER
if [ -d "$INSTALL_PATH" ]; then
    echo "[INFO] Existing installation detected."
    printf "Reinstall and overwrite? (y/n): "
    read choice
    if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
        echo "[ACTION] Unmounting and cleaning previous paths..."
        umount -l /www 2>/dev/null
        rm -rf "$INSTALL_PATH"
    else
        echo "[INFO] Installation aborted."
        exit 0
    fi
fi

# 3. DIRECTORY MIRRORING
echo "[1/7] Mirroring system files to JFFS..."
mkdir -p "$INSTALL_PATH"
# Menyalin seluruh isi directory /www ke /jffs/mywww
cp -a /www/. "$INSTALL_PATH/"
echo "[SUCCESS] System directory mirrored to JFFS."

# 4. TARGET DELETION
echo "[2/7] Removing original default.css from JFFS..."
rm -f "$INSTALL_PATH/default.css"

# Verifikasi apakah file sudah benar-benar hilang
if [ -f "$INSTALL_PATH/default.css" ]; then
    echo "[ERROR] Failed to delete default.css. Process halted."
    exit 1
fi
echo "[SUCCESS] original default.css has been removed."

# 5. DOWNLOAD PHASE
mkdir -p "$TEMP_WORKSPACE"
cd "$TEMP_WORKSPACE" || exit
echo "[3/7] Downloading theme package from GitHub..."
wget --no-check-certificate -U "Mozilla/5.0" "$SOURCE_URL"

if [ ! -s "BocchiTheme.tar" ]; then
    echo "[ERROR] Download failed or file is empty."
    exit 1
fi

# 6. EXTRACTION
echo "[4/7] Extracting theme assets..."
tar -xf BocchiTheme.tar

# 7. DEPLOYMENT
echo "[5/7] Deploying new assets to JFFS..."
# Menyalin file hasil ekstrak (default.css baru, logo, gif) ke JFFS
cp -a . "$INSTALL_PATH/"

# Cleanup RAM workspace
cd /
rm -rf "$TEMP_WORKSPACE"

# 8. NVRAM PERSISTENCE
echo "[6/7] Configuring persistence (NVRAM)..."
CURRENT_INIT=$(nvram get script_init)
if ! echo "$CURRENT_INIT" | grep -q "$INSTALL_PATH"; then
    nvram set script_init="$CURRENT_INIT
sleep 5
if [ -d $INSTALL_PATH ]; then
    mount --bind $INSTALL_PATH /www
    service httpd restart
fi"
    nvram commit
fi

# 9. RE-MOUNT & ACTIVATION
echo "[7/7] Re-mounting /www to JFFS and restarting Web Server..."
# Memastikan folder JFFS di-mount ulang ke /www sistem
umount -l /www 2>/dev/null
mount --bind "$INSTALL_PATH" /www
service httpd restart

echo "===================================================="
echo "           INSTALLATION SUCCESSFUL!                 "
echo "===================================================="
echo " New default.css and assets are now active.         "
echo " Please refresh your browser (Clear Cache).         "
echo "===================================================="

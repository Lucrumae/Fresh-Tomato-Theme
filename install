#!/bin/sh

# =================================================================
# GLOBAL CONFIGURATION
# =================================================================
BASE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main"
LIST_FILE="ThemeList.txt"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_deploy"

# ANSI Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# FIX 1: Cleanup RAM saat exit/error
cleanup() {
    [ -d "$TEMP_WORKSPACE" ] && rm -rf "$TEMP_WORKSPACE"
}
trap cleanup EXIT INT TERM

# =================================================================
# PHASE 1: THEME SELECTION MENU
# =================================================================
clear
echo -e "${CYAN}===================================================="
echo -e "      FreshTomato Multi-Theme Installer Pro"
echo -e "      Database: ${LIST_FILE}"
echo -e "${CYAN}====================================================${NC}"

mkdir -p "$TEMP_WORKSPACE"
echo -n "Fetching theme catalog... "

# FIX 2: Tambah timeout pada wget agar tidak hang selamanya
wget --no-check-certificate --timeout=15 --tries=2 \
    "$BASE_URL/$LIST_FILE" -O "$TEMP_WORKSPACE/list.txt" >/dev/null 2>&1

if [ ! -s "$TEMP_WORKSPACE/list.txt" ]; then
    echo -e "${RED}[FAILED]${NC}"
    echo -e "Error: Could not retrieve theme list from GitHub."
    exit 1
fi
echo -e "${GREEN}[OK]${NC}"

echo -e "\n${YELLOW}Available Themes in Repository:${NC}"
echo -e "----------------------------------------------------"

# FIX 3: Ganti eval dengan array sederhana pakai file temp
# eval + input user = risiko command injection
i=1
while IFS='|' read -r name folder || [ -n "$name" ]; do
    clean_name=$(echo "$name" | tr -d '\r\n')
    clean_folder=$(echo "$folder" | tr -d '\r\n')
    [ -z "$clean_name" ] && continue
    echo -e "${CYAN}$i)${NC} $clean_name"
    # Simpan ke file temp, bukan eval
    echo "$clean_name" >> "$TEMP_WORKSPACE/names.txt"
    echo "$clean_folder" >> "$TEMP_WORKSPACE/folders.txt"
    i=$((i+1))
done < "$TEMP_WORKSPACE/list.txt"

total_themes=$((i-1))
if [ "$total_themes" -eq 0 ]; then
    echo -e "${RED}No themes found in catalog.${NC}"
    exit 1
fi

echo -e "----------------------------------------------------"
printf "Enter selection (1-$total_themes): "
read choice

# FIX 4: Validasi input - harus angka, dalam range yang benar
case "$choice" in
    ''|*[!0-9]*)
        echo -e "${RED}Invalid input: please enter a number.${NC}"
        exit 1
        ;;
esac

if [ "$choice" -lt 1 ] || [ "$choice" -gt "$total_themes" ]; then
    echo -e "${RED}Invalid selection. Please choose between 1 and $total_themes.${NC}"
    exit 1
fi

# Ambil nama dan folder dari file temp (aman, tanpa eval)
SELECTED_NAME=$(sed -n "${choice}p" "$TEMP_WORKSPACE/names.txt")
SELECTED_FOLDER=$(sed -n "${choice}p" "$TEMP_WORKSPACE/folders.txt")

if [ -z "$SELECTED_NAME" ] || [ -z "$SELECTED_FOLDER" ]; then
    echo -e "${RED}Could not resolve theme selection. Aborting.${NC}"
    exit 1
fi

echo -e "\n${GREEN}Selected: $SELECTED_NAME${NC}"

# =================================================================
# PHASE 2: SYSTEM & SPACE CHECKS
# =================================================================
log_step() { echo -e "${CYAN}[$1/5]${NC} $2"; }

if ! mount | grep -q "/jffs"; then
    echo -e "${RED}[ERROR] JFFS partition is not active.${NC}"
    exit 1
fi

FREE_JFFS=$(df -k /jffs | awk 'NR==2 {print $4}')
if [ "$FREE_JFFS" -lt 10240 ]; then
    echo -e "${YELLOW}[WARNING] Low JFFS space ($((FREE_JFFS/1024))MB). Installation might fail.${NC}"
fi

# =================================================================
# PHASE 3: PREPARATION & MIRRORING
# =================================================================
log_step "1" "Cleaning previous environment..."

# FIX 5: Cek apakah /www sudah di-mount sebelum umount
if mount | grep -q " /www "; then
    umount -l /www 2>/dev/null
fi

[ -d "$INSTALL_PATH" ] && rm -rf "$INSTALL_PATH"

log_step "2" "Mirroring system files to JFFS..."
mkdir -p "$INSTALL_PATH"
cp -a /www/. "$INSTALL_PATH/"
rm -f "$INSTALL_PATH/default.css"

# =================================================================
# PHASE 4: DOWNLOAD & DEPLOYMENT
# =================================================================
THEME_URL="$BASE_URL/$SELECTED_FOLDER/Theme.tar"

log_step "3" "Downloading $SELECTED_NAME package..."

# FIX 6: Tambah timeout pada download theme juga
wget --no-check-certificate --timeout=30 --tries=2 \
    "$THEME_URL" -O "$TEMP_WORKSPACE/Theme.tar"

if [ $? -ne 0 ] || [ ! -s "$TEMP_WORKSPACE/Theme.tar" ]; then
    echo -e "${RED}[ERROR] Failed to download Theme.tar from $SELECTED_FOLDER${NC}"
    exit 1
fi

log_step "4" "Extracting assets to JFFS storage..."

# FIX 7: Cek apakah tar berhasil sebelum lanjut
tar -xf "$TEMP_WORKSPACE/Theme.tar" -C "$INSTALL_PATH/"
if [ $? -ne 0 ]; then
    echo -e "${RED}[ERROR] Failed to extract Theme.tar. File might be corrupted.${NC}"
    exit 1
fi

# =================================================================
# PHASE 5: PERSISTENCE & ACTIVATION
# =================================================================
log_step "5" "Configuring boot sequence & Permissions..."

chmod 755 "$INSTALL_PATH"

# FIX 8: Pisah permission untuk file biasa vs executable
# .sh dan .cgi butuh 755, file lain cukup 644
find "$INSTALL_PATH" -type f \( -name "*.sh" -o -name "*.cgi" \) -exec chmod 755 {} \;
find "$INSTALL_PATH" -type f ! \( -name "*.sh" -o -name "*.cgi" \) -exec chmod 644 {} \;

# FIX 9: Sanitasi SELECTED_FOLDER sebelum masuk ke nvram
# Hanya izinkan karakter aman (huruf, angka, dash, underscore, slash)
SAFE_FOLDER=$(echo "$SELECTED_FOLDER" | tr -cd 'a-zA-Z0-9/_-')
SAFE_PATH=$(echo "$INSTALL_PATH" | tr -cd 'a-zA-Z0-9/_-')

CURRENT_INIT=$(nvram get script_init | sed "/# --- Theme Startup ---/,/fi/d")
nvram set script_init="$CURRENT_INIT
# --- Theme Startup ---
sleep 10
if [ -d $SAFE_PATH ]; then
    chmod 755 $SAFE_PATH
    find $SAFE_PATH -type f \( -name '*.sh' -o -name '*.cgi' \) -exec chmod 755 {} \;
    find $SAFE_PATH -type f ! \( -name '*.sh' -o -name '*.cgi' \) -exec chmod 644 {} \;
    mount --bind $SAFE_PATH /www
    service httpd restart
fi"
nvram commit

# Final Activation
mount --bind "$INSTALL_PATH" /www
service httpd restart

echo -e "\n${GREEN}===================================================="
echo -e "      INSTALLATION SUCCESSFUL: $SELECTED_NAME"
echo -e "====================================================${NC}"
echo -e "Status: ${CYAN}Active${NC}"
echo -e "RAM Usage: ${CYAN}Auto-Cleaned${NC}"
echo -e "\nAction: Please Clear Browser Cache (CTRL+F5)"
echo -e "----------------------------------------------------"

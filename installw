#!/bin/sh

# =================================================================
# GLOBAL CONFIGURATION
# =================================================================
APP_NAME="BocchiTheRockTheme"
VERSION="2026.5-PRO-LIGHT"
# URL Langsung ke file TAR (GitHub Raw)
SOURCE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main/BocchiTheRockTheme/BocchiTheme.tar"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_deploy"
REQUIRED_SPACE_KB=15360 # Lebih hemat RAM (15MB sudah cukup)

# Manual Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' 

# =================================================================
# PHASE 1: PRE-FLIGHT CHECKS
# =================================================================
clear
echo -e "${CYAN}===================================================="
echo -e "      ${GREEN}${APP_NAME} Installer - v${VERSION}${NC}"
echo -e "      Direct Asset Deployment for FreshTomato"
echo -e "${CYAN}====================================================${NC}"

echo -e "${CYAN}[1/5]${NC} Verifying JFFS storage..."
if ! mount | grep -q "/jffs"; then
    echo -e "${RED}ERROR: JFFS partition not mounted.${NC}"
    exit 1
fi

# =================================================================
# PHASE 2: PREPARATION & MIRRORING
# =================================================================
if [ -d "$INSTALL_PATH" ]; then
    echo -e "${CYAN}[2/5]${NC} Cleaning previous deployment..."
    umount -l /www 2>/dev/null
    rm -rf "$INSTALL_PATH"
fi

echo -e "${CYAN}[3/5]${NC} Mirroring system UI to JFFS..."
mkdir -p "$INSTALL_PATH"
cp -a /www/. "$INSTALL_PATH/"
rm -f "$INSTALL_PATH/default.css"

# =================================================================
# PHASE 3: DIRECT DOWNLOAD & EXTRACTION
# =================================================================
echo -e "${CYAN}[4/5]${NC} Downloading theme package..."
rm -rf "$TEMP_WORKSPACE"
mkdir -p "$TEMP_WORKSPACE"

# Menggunakan wget standar tanpa parameter rumit
wget --no-check-certificate "$SOURCE_URL" -O "$TEMP_WORKSPACE/BocchiTheme.tar"

if [ $? -ne 0 ]; then
    echo -e "${RED}ERROR: Download failed. Check your URL or Connection.${NC}"
    exit 1
fi

echo "Extracting assets to $INSTALL_PATH..."
tar -xf "$TEMP_WORKSPACE/BocchiTheme.tar" -C "$INSTALL_PATH/"

# Cleanup workspace
rm -rf "$TEMP_WORKSPACE"

# =================================================================
# PHASE 4: PERMISSIONS & PERSISTENCE
# =================================================================
echo -e "${CYAN}[5/5]${NC} Hardening permissions & NVRAM sequence..."
chmod 755 "$INSTALL_PATH"
chmod 644 "$INSTALL_PATH"/*

# Membersihkan dan menulis ulang script init
CURRENT_INIT=$(nvram get script_init | sed "/# --- Bocchi Startup ---/,/fi/d")
nvram set script_init="$CURRENT_INIT
# --- Bocchi Startup ---
sleep 10
if [ -d $INSTALL_PATH ]; then
    chmod 755 $INSTALL_PATH
    chmod 644 $INSTALL_PATH/*
    mount --bind $INSTALL_PATH /www
    service httpd restart
fi"
nvram commit

# =================================================================
# PHASE 5: ACTIVATION
# =================================================================
umount -l /www 2>/dev/null
mount --bind "$INSTALL_PATH" /www
service httpd restart

# Verifikasi
if [ -f "/www/bg.png" ]; then
    echo -e "${GREEN}===================================================="
    echo "         SUCCESS: THEME DEPLOYED DIRECTLY"
    echo "===================================================="
    echo -e "${NC} Action: Please Clear Browser Cache (CTRL+F5)"
    echo -e "${CYAN}====================================================${NC}"
else
    echo -e "${RED}ERROR: Verification failed. Assets missing.${NC}"
    exit 1
fi

#!/bin/sh

# =================================================================
# GLOBAL CONFIGURATION
# =================================================================
BASE_URL="https://raw.githubusercontent.com/Lucrumae/Fresh-Tomato-Theme/main"
LIST_FILE="ThemeList.txt"
INSTALL_PATH="/jffs/mywww"
TEMP_WORKSPACE="/tmp/theme_deploy"

# ANSI Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Auto-cleanup on exit
cleanup() {
    [ -d "$TEMP_WORKSPACE" ] && rm -rf "$TEMP_WORKSPACE"
}
trap cleanup EXIT INT TERM

# =================================================================
# PHASE 1: FETCHING & PARSING THEME LIST
# =================================================================
clear
echo -e "${CYAN}===================================================="
echo -e "      FreshTomato Multi-Theme Installer Pro"
echo -e "      Database: ${LIST_FILE}"
echo -e "${CYAN}====================================================${NC}"

mkdir -p "$TEMP_WORKSPACE"
echo -n "Connecting to repository... "
wget --no-check-certificate "$BASE_URL/$LIST_FILE" -O "$TEMP_WORKSPACE/list.txt" >/dev/null 2>&1

if [ ! -s "$TEMP_WORKSPACE/list.txt" ]; then
    echo -e "${RED}[FAILED]${NC}"
    echo -e "Error: Could not retrieve ${LIST_FILE} from GitHub."
    exit 1
fi
echo -e "${GREEN}[OK]${NC}"

echo -e "\n${YELLOW}Available Themes:${NC}"
echo -e "----------------------------------------------------"

# Menampilkan menu pilihan
i=1
while IFS='|' read -r name folder || [ -n "$name" ]; do
    # Bersihkan karakter carriage return (\r) jika file diedit di Windows
    clean_name=$(echo "$name" | tr -d '\r')
    clean_folder=$(echo "$folder" | tr -d '\r')
    
    [ -z "$clean_name" ] && continue
    
    echo -e "${CYAN}$i)${NC} $clean_name"
    
    # Simpan pilihan ke variabel dinamis
    eval "NAME_$i=\"$clean_name\""
    eval "FOLDER_$i=\"$clean_folder\""
    i=$((i+1))
done < "$TEMP_WORKSPACE/list.txt"

total_themes=$((i-1))
if [ "$total_themes" -eq 0 ]; then
    echo -e "${RED}No themes found in the list.${NC}"
    exit 1
fi

echo -e "----------------------------------------------------"
printf "Select theme number (1-$total_themes): "
read choice

# Validasi Input
SELECTED_NAME=$(eval echo \$NAME_$choice)
SELECTED_FOLDER=$(eval echo \$FOLDER_$choice)

if [ -z "$SELECTED_NAME" ]; then
    echo -e "${RED}Invalid selection. Installation aborted.${NC}"
    exit 1
fi

echo -e "\n${GREEN}Preparing to install: $SELECTED_NAME...${NC}"

# =================================================================
# PHASE 2: SYSTEM PREPARATION
# =================================================================
if ! mount | grep -q "/jffs"; then
    echo -e "${RED}[ERROR] JFFS partition is not mounted.${NC}"
    exit 1
fi

# Clean Reinstall
if [ -d "$INSTALL_PATH" ]; then
    echo -e "${CYAN}[1/4]${NC} Removing previous theme..."
    umount -l /www 2>/dev/null
    rm -rf "$INSTALL_PATH"
fi

echo -e "${CYAN}[2/4]${NC} Mirroring system UI to JFFS..."
mkdir -p "$INSTALL_PATH"
cp -a /www/. "$INSTALL_PATH/"
rm -f "$INSTALL_PATH/default.css"

# =================================================================
# PHASE 3: DOWNLOAD SELECTED THEME
# =================================================================
# Asumsi: Setiap folder memiliki file 'BocchiTheme.tar'
THEME_URL="$BASE_URL/$SELECTED_FOLDER/BocchiTheme.tar"

echo -e "${CYAN}[3/4]${NC} Downloading assets from: $SELECTED_FOLDER"
wget --no-check-certificate "$THEME_URL" -O "$TEMP_WORKSPACE/theme.tar"

if [ $? -ne 0 ]; then
    echo -e "${RED}[ERROR] Download failed. Check if BocchiTheme.tar exists in $SELECTED_FOLDER.${NC}"
    exit 1
fi

tar -xf "$TEMP_WORKSPACE/theme.tar" -C "$INSTALL_PATH/"

# =================================================================
# PHASE 4: PERSISTENCE & ACTIVATION
# =================================================================
echo -e "${CYAN}[4/4]${NC} Finalizing system integration..."
chmod 755 "$INSTALL_PATH"
chmod 644 "$INSTALL_PATH"/*

# Update NVRAM boot script
CURRENT_INIT=$(nvram get script_init | sed "/# --- Theme Startup ---/,/fi/d")
nvram set script_init="$CURRENT_INIT
# --- Theme Startup ---
sleep 10
if [ -d $INSTALL_PATH ]; then
    chmod 755 $INSTALL_PATH
    chmod 644 $INSTALL_PATH/*
    mount --bind $INSTALL_PATH /www
    service httpd restart
fi"
nvram commit

# Activate
umount -l /www 2>/dev/null
mount --bind "$INSTALL_PATH" /www
service httpd restart

echo -e "\n${GREEN}===================================================="
echo -e "      INSTALLATION COMPLETE: $SELECTED_NAME"
echo -e "====================================================${NC}"
echo -e "Note: Please perform a Hard Refresh (CTRL+F5) in your browser."

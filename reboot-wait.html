<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rebooting…</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#080610;
  font-family:Outfit,ui-sans-serif,sans-serif}
#bg{position:fixed;inset:0;width:100vw;height:100vh;
  object-fit:cover;z-index:0;pointer-events:none}
#ov{position:fixed;inset:0;z-index:1;
  background:rgba(8,6,10,.50);transition:background 1.2s ease}
#wrap{position:fixed;inset:0;z-index:2;
  display:flex;align-items:center;justify-content:center}
#card{background:rgba(8,6,10,.55);border:1px solid rgba(255,255,255,.10);
  border-radius:20px;padding:44px 52px;backdrop-filter:blur(24px);
  -webkit-backdrop-filter:blur(24px);box-shadow:0 8px 48px rgba(0,0,0,.6);
  text-align:center;min-width:300px;
  transition:background 1.2s ease,border-color 1.2s ease;
  animation:cardIn .5s cubic-bezier(.22,1,.36,1)}
@keyframes cardIn{
  from{opacity:0;transform:translateY(20px) scale(.97)}
  to{opacity:1;transform:translateY(0) scale(1)}}
#ico{width:48px;height:48px;display:block;margin:0 auto 20px;
  animation:spin 1.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#ttl{font-size:18px;font-weight:700;color:#f0ece8;
  letter-spacing:-.01em;margin-bottom:6px}
#sub{font-size:11px;color:rgba(240,236,232,.40);letter-spacing:.14em;
  text-transform:uppercase;font-family:"Space Mono",monospace;margin-bottom:28px}
#bwrap{width:100%;height:3px;background:rgba(255,255,255,.08);
  border-radius:4px;overflow:hidden;margin-bottom:14px}
#bar{height:100%;width:0%;border-radius:4px;
  background:linear-gradient(90deg,var(--a,#e8a86e),var(--a2,#7ec8e3));
  transition:width 1s linear}
#cnt{font-size:12px;color:rgba(240,236,232,.45);letter-spacing:.04em}
#cnt b{color:var(--a,#e8a86e);font-size:14px}
#status{font-size:11px;color:rgba(240,236,232,.30);margin-top:10px;
  font-family:"Space Mono",monospace;letter-spacing:.06em}
</style>
</head>
<body>
<video id="bg" autoplay loop muted playsinline>
  <source src="/bgmp4.gif" type="video/mp4">
</video>
<div id="ov"></div>
<div id="wrap">
  <div id="card">
    <svg id="ico" viewBox="0 0 24 24" fill="none"
      stroke="var(--a,#e8a86e)" stroke-width="1.5"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 2v6h-6"/>
      <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
      <path d="M3 22v-6h6"/>
      <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
    </svg>
    <div id="ttl">Rebooting Router</div>
    <div id="sub">Please Wait</div>
    <div id="bwrap"><div id="bar"></div></div>
    <div id="cnt">Redirecting in <b id="num">120</b>s</div>
    <div id="status">Sending reboot command…</div>
  </div>
</div>
<script>
(function(){
  var total   = 120;
  var elapsed = 0;
  var bar     = document.getElementById('bar');
  var num     = document.getElementById('num');
  var status  = document.getElementById('status');
  var ov      = document.getElementById('ov');
  var card    = document.getElementById('card');
  var ico     = document.getElementById('ico');

  // ── 1. Baca credentials dari cookie ft_auth ──────────────────
  function getCred(){
    var m = document.cookie.match(/(?:^|;\s*)ft_auth=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  // ── 2. Kirim reboot command ke httpd:8008 langsung ───────────
  //    (bypass nginx — langsung ke FreshTomato httpd dengan Basic Auth)
  function sendReboot(){
    var cred = getCred();
    if(!cred){ setStatus('No credentials — check login'); return; }

    var body = 'submit_button=status-overview&_nextpage=admin-reboot.asp&_action=reboot';

    // Coba XHR ke httpd langsung di port 8008
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'http://192.168.1.1:8008/tomato.cgi', true);
    xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
    xhr.setRequestHeader('Authorization', cred);
    xhr.timeout = 10000;
    xhr.onreadystatechange = function(){
      if(xhr.readyState === 4){
        if(xhr.status === 200 || xhr.status === 302 || xhr.status === 0){
          setStatus('Reboot sent — waiting for restart…');
        } else {
          setStatus('Sent (status ' + xhr.status + ')');
        }
        startCountdown();
      }
    };
    xhr.ontimeout = xhr.onerror = function(){
      // Timeout/error = router sudah mulai reboot (disconnect)
      setStatus('Reboot in progress…');
      startCountdown();
    };
    xhr.send(body);

    // Safety: mulai countdown setelah 3 detik walau tidak ada response
    setTimeout(startCountdown, 3000);
  }

  // ── 3. Countdown + progress bar ──────────────────────────────
  var countdownStarted = false;
  function startCountdown(){
    if(countdownStarted) return;
    countdownStarted = true;
    var timer = setInterval(function(){
      elapsed++;
      bar.style.width = Math.min((elapsed/total)*100, 100) + '%';
      num.textContent = Math.max(total - elapsed, 0);
      if(elapsed >= total) clearInterval(timer);
    }, 1000);
  }

  // ── 4. Poll router sampai online ─────────────────────────────
  function pollOnline(){
    fetch('/login.html',{method:'HEAD',cache:'no-store',credentials:'omit'})
      .then(function(r){
        if(r.ok){
          setStatus('Router online — redirecting…');
          setTimeout(function(){ window.location.replace('/'); }, 1000);
        } else { setTimeout(pollOnline, 4000); }
      })
      .catch(function(){ setTimeout(pollOnline, 4000); });
  }
  // Mulai poll setelah 20 detik (minimum reboot time)
  setTimeout(pollOnline, 20000);

  // ── 5. Adaptive color dari video ─────────────────────────────
  var vid = document.getElementById('bg');
  var cv  = document.createElement('canvas');
  cv.width = 64; cv.height = 36;
  var ctx = cv.getContext('2d'), lastHue = -1;

  function H(h,s,l){h/=360;s/=100;l/=100;var q=l<.5?l*(1+s):l+s-l*s,p=2*l-q;function f(t){t<0&&(t+=1);t>1&&(t-=1);return t<1/6?p+(q-p)*6*t:t<.5?q:t<2/3?p+(q-p)*(2/3-t)*6:p;}return[~~(f(h+1/3)*255),~~(f(h)*255),~~(f(h-1/3)*255)];}
  function toHsl(r,g,b){r/=255;g/=255;b/=255;var mx=Math.max(r,g,b),mn=Math.min(r,g,b),h,s,l=(mx+mn)/2;if(mx===mn){h=s=0;}else{var d=mx-mn;s=l>.5?d/(2-mx-mn):d/(mx+mn);h=mx===r?((g-b)/d+(g<b?6:0))/6:mx===g?((b-r)/d+2)/6:((r-g)/d+4)/6;}return[h*360,s*100,l*100];}

  function sample(){
    if(vid.readyState < 2){ setTimeout(sample, 500); return; }
    try{
      ctx.drawImage(vid,0,0,64,36);
      var px=ctx.getImageData(0,0,64,36).data,r=0,g=0,b=0,n=0;
      for(var i=0;i<px.length;i+=4){
        var br=(px[i]+px[i+1]+px[i+2])/3;
        if(br<15||br>240) continue;
        r+=px[i];g+=px[i+1];b+=px[i+2];n++;
      }
      if(!n){ setTimeout(sample,500); return; }
      r=~~(r/n);g=~~(g/n);b=~~(b/n);
      var hsl=toHsl(r,g,b),hue=hsl[0],sat=hsl[1],lum=hsl[2];
      var d=Math.abs(hue-lastHue); if(d>180) d=360-d;
      if(lastHue<0||d>=5){
        lastHue=hue;
        var dark=lum<50, s2=Math.max(sat,50);
        var acc=H(hue,Math.max(s2,65),dark?68:42);
        var ac2=H((hue+40)%360,Math.max(s2,55),dark?72:40);
        var pan=H(hue,Math.min(s2,40),dark?Math.min(lum+8,20):Math.max(lum-8,80));
        var ovC=Math.max(pan[0]-30,0)+','+Math.max(pan[1]-30,0)+','+Math.max(pan[2]-30,0);
        var aStr='rgb('+acc[0]+','+acc[1]+','+acc[2]+')';
        var a2Str='rgb('+ac2[0]+','+ac2[1]+','+ac2[2]+')';
        ov.style.background='rgba('+ovC+',.50)';
        card.style.background='rgba('+pan[0]+','+pan[1]+','+pan[2]+',.48)';
        card.style.borderColor='rgba('+acc[0]+','+acc[1]+','+acc[2]+',.20)';
        document.documentElement.style.setProperty('--a', aStr);
        document.documentElement.style.setProperty('--a2', a2Str);
        ico.setAttribute('stroke', aStr);
      }
    }catch(e){}
    setTimeout(sample,500);
  }
  vid.addEventListener('canplay', sample, {once:true});
  vid.play().catch(function(){});

  function setStatus(msg){ if(status) status.textContent = msg; }

  // ── Start ─────────────────────────────────────────────────────
  sendReboot();
})();
</script>
</body>
</html>
